name: Publish Javadoc

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  publish-javadoc:
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: ${{ github.head_ref || github.ref_name }}
    steps:
      - name: Checkout sources (full history)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Gradle
        uses: ./.github/actions/setup-gradle

      - name: Set Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare gh-pages branch (force-replace with source)
        run: |
          git fetch origin "$SOURCE_BRANCH" || true
          git checkout --force -B gh-pages origin/"$SOURCE_BRANCH"

      - name: Generate Javadoc
        run: ./gradlew javadoc

      - name: Copy Javadoc to docs
        run: |
          mkdir -p docs
          rm -rf docs/*
          if [ ! -d build/docs/javadoc ] || [ -z "$(ls -A build/docs/javadoc)" ]; then
            echo "Error: No Javadoc files found in build/docs/javadoc. Aborting publish."
            exit 1
          fi
          cp -r build/docs/javadoc/* docs/

      - name: Commit and push Javadoc to gh-pages
        run: |
          git add .
          git commit -m "Update Javadoc from $SOURCE_BRANCH" || echo "No changes to commit"
          git push --force origin gh-pages
