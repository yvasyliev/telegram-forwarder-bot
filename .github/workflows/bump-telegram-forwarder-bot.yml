name: Bump Telegram Forwarder Bot

permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get latest release version
        id: get-release
        run: |
          LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "latest-release=${LATEST_RELEASE#v}" >> $GITHUB_OUTPUT

      - name: Get merged PRs since latest release
        id: get-prs
        env:
          LATEST_RELEASE: ${{ steps.get-release.outputs.latest-release }}
        run: |
          SINCE=$(gh release view "v$LATEST_RELEASE" --json publishedAt --jq '.publishedAt')
          PRS=$(gh pr list --state merged --search "label:patch label:minor label:major merged:>${SINCE}" --json number,labels,mergedAt)
          echo "prs=$PRS" >> $GITHUB_OUTPUT

      - name: Get bump type
        id: get-bump-type
        env:
          PRS: ${{ steps.get-prs.outputs.prs }}
        run: |
          if echo "$PRS" | jq -e '. | length == 0' >/dev/null; then
            echo "bump-type=" >> $GITHUB_OUTPUT
            exit 0
          fi
          LABEL=patch
          if echo "$PRS" | jq -e '[.[].labels[].name] | index("minor")' >/dev/null; then
            LABEL=minor
          fi
          if echo "$PRS" | jq -e '[.[].labels[].name] | index("major")' >/dev/null; then
            LABEL=major
          fi
          echo "bump-type=$LABEL" >> $GITHUB_OUTPUT

      - name: Bump version
        if: steps.get-bump-type.outputs.bump-type != ''
        id: bump-version
        env:
          VERSION: ${{ steps.get-release.outputs.latest-release }}
          BUMP_TYPE: ${{ steps.get-bump-type.outputs.bump-type }}
        run: |
          echo "old-version=$VERSION" >> $GITHUB_OUTPUT
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR+1)); PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH+1))
          fi
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          sed -i "s/^\s*version = '.*'/version = '$NEW_VERSION'/" build.gradle

      - name: Setup Git user
        if: steps.get-bump-type.outputs.bump-type != ''
        uses: ./.github/actions/setup-git-user

      - name: Create Pull Request
        if: steps.get-bump-type.outputs.bump-type != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_BRANCH: release/v${{ steps.bump-version.outputs.new-version }}
          COMMIT_MESSAGE: Bump io.github.yvasyliev.forwarder.telegram from ${{ steps.bump-version.outputs.old-version }} to ${{ steps.bump-version.outputs.new-version }}
          BODY: Bumps [io.github.yvasyliev.forwarder.telegram](https://github.com/yvasyliev/telegram-forwarder-bot) from ${{ steps.bump-version.outputs.old-version }} to ${{ steps.bump-version.outputs.new-version }}
        run: |
          DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq .defaultBranchRef.name)
          git checkout -b "$NEW_BRANCH"
          git add build.gradle
          git commit -m "$COMMIT_MESSAGE"
          git push origin "$NEW_BRANCH"
          gh pr create --title "$COMMIT_MESSAGE" --body "$BODY" --base "$DEFAULT_BRANCH"
