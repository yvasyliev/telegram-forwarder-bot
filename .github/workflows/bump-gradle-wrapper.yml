name: Bump Gradle Wrapper

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:

jobs:
  bump-gradle-wrapper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Gradle
        uses: ./.github/actions/setup-gradle

      - name: Get old Gradle version
        id: old-version
        run: |
          OLD_VERSION=$(./gradlew --version | grep 'Gradle ' | awk '{print $2}')
          echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT

      - name: Bump Gradle wrapper
        run: |
          ./gradlew wrapper --gradle-version latest
          ./gradlew wrapper

      - name: Get new Gradle version
        id: new-version
        run: |
          NEW_VERSION=$(./gradlew --version | grep 'Gradle ' | awk '{print $2}')
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Git user
        if: steps.old-version.outputs.old-version != steps.new-version.outputs.new-version
        uses: ./.github/actions/setup-git-user

      - name: Commit and push changes
        if: steps.old-version.outputs.old-version != steps.new-version.outputs.new-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: feature/gradle
          COMMIT_MESSAGE: Bump Gradle wrapper from ${{ steps.old-version.outputs.old-version }} to ${{ steps.new-version.outputs.new-version }}
        run: |
          git checkout -b "$BRANCH"
          git add .
          git commit -m "$COMMIT_MESSAGE"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: steps.old-version.outputs.old-version != steps.new-version.outputs.new-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: Bump Gradle wrapper from ${{ steps.old-version.outputs.old-version }} to ${{ steps.new-version.outputs.new-version }}
          BODY: Bumps [Gradle wrapper](https://docs.gradle.org/current/userguide/gradle_wrapper.html) from ${{ steps.old-version.outputs.old-version }} to ${{ steps.new-version.outputs.new-version }}
        run: |
          DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq .defaultBranchRef.name)
          gh pr create --title "$TITLE" --body "$BODY" --base "$DEFAULT_BRANCH"
